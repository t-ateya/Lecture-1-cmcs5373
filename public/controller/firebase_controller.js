import * as Constant from '../model/constant.js'
import {
    Message
} from '../model/message.js'
import {
    Thread
} from '../model/thread.js'

export async function signIn(email, password) {
    // @ts-ignore
    await firebase.auth().signInWithEmailAndPassword(email, password)
}

export async function signOut() {
    // @ts-ignore
    await firebase.auth().signOut()
}

export async function addThread(thread) {
    // @ts-ignore
    const ref = await firebase.firestore()
        .collection(Constant.collectionName.THREADS)
        .add(thread.serialize())
    return ref.id //unique document id generated by Firestore
}

export async function deleteThread(threadId) {
    // @ts-ignore
    await firebase.firestore().collection(Constant.collectionName.THREADS).doc(threadId).delete()
}

export async function deleteThreadMessage(threadId) {
    // @ts-ignore
    const snapShot = await firebase.firestore()
        .collection(Constant.collectionName.MESSAGES)
        .where('threadId', '==', threadId)
        .orderBy('timestamp')
        .get()

    // @ts-ignore
    let messages = []
    snapShot.forEach(doc => {
        const m = new Message(doc.data())
            // @ts-ignore
        m.docId = doc.id
            // @ts-ignore
        firebase.firestore().collection(Constant.collectionName.MESSAGES).doc(m.docId).delete()
    })
}

export async function getThreadList() {
    let threadList = []
        // @ts-ignore
    const snapShot = await firebase.firestore()
        .collection(Constant.collectionName.THREADS)
        .orderBy('timestamp', 'desc')
        .get()
    snapShot.forEach(doc => {
        const t = new Thread(doc.data())
            // @ts-ignore
        t.docId = doc.id
        threadList.push(t)
    })
    return threadList
}

export async function getOneThread(threadId) {
    // @ts-ignore
    const ref = await firebase.firestore().collection(Constant.collectionName.THREADS)
        .doc(threadId).get()
    if (!ref.exists) {
        return null
    }
    const t = new Thread(ref.data())
        // @ts-ignore
    t.docId = threadId
    return t
}

export async function addMessage(message) {
    // @ts-ignore
    const ref = await firebase.firestore().collection(Constant.collectionName.MESSAGES)
        .add(message.serialize())
    return ref.id
}

export async function getMessageList(threadId) {
    // @ts-ignore
    const snapShot = await firebase.firestore().collection(Constant.collectionName.MESSAGES)
        .where('threadId', '==', threadId)
        .orderBy('timestamp')
        .get()

    let messages = []
    snapShot.forEach(doc => {
        const m = new Message(doc.data())
            // @ts-ignore
        m.docId = doc.id
        messages.push(m)
    })
    return messages
}

export async function searchThreads(keywordsArray) {
    const threadList = []
        // @ts-ignore
    const snapShot = await firebase.firestore().collection(Constant.collectionName.THREADS)
        .where('keywordsArray', 'array-contains-any', keywordsArray)
        .orderBy('timestamp', 'desc')
        .get()
    snapShot.forEach(doc => {
        const t = new Thread(doc.data())
            // @ts-ignore
        t.docId = doc.id
        threadList.push(t)
    })
    return threadList
}

export async function signUp(email, password) {
    // @ts-ignore
    await firebase.auth().createUserWithEmailAndPassword(email, password)
}